<div id="navigator-header-container">
    <uasdm-header [title]="'Site Viewer'"></uasdm-header>
</div>

<div id="app-container" class="container-fluid" style="background: #f7f7f7;">

    <div class="row">
        <div id="navigator-left-sidebar" class="col-md-3 lw-inner-col">
            <div class="row">
              <div class="col-md-12">
            
                  <!-- IF at Site level -->
                  <div class="row" *ngIf="!current">
                    <div class="col-md-6" style="height: 56px;">
                      <h3>IDM Sites</h3>
                    </div>
                  </div>
            
                  <!-- IF lower than Site -->
                  <div class="row" *ngIf="current">
                    <div class="col-md-12" style="height: 56px; overflow: scroll;">
                      <ul class="breadcrumb" style="background-color: white;">
                        <li>
                          <i class="fa fa-angle-left breadcrumb-back-ico" aria-hidden="true"></i>
                          <a (click)="back(null)" style="color: #007276;">IDM Sites</a>
                        </li>
                        <li *ngFor="let entity of breadcrumbs; last as isLast" [ngClass]="{'active':isLast}">
                          <a *ngIf="!isLast" (click)="back(entity)" style="color: #007276;"> {{entity.name}}</a>
                          <span *ngIf="isLast"> <b>{{entity.name}}</b> </span>
                        </li>
                      </ul>
                    </div>
                  </div>
            
                  <!-- Search bar -->
                  <div class="row">
                    <div class="col-md-12">
                      <div class="location-management-widget-section">
                        <input class="form-control search-input" type="text" placeholder="Search..." [(ngModel)]="search"
                          [typeaheadAsync]="true" [typeahead]="dataSource" (typeaheadOnSelect)="handleClick($event)"
                          [typeaheadOptionsLimit]="10" [typeaheadItemTemplate]="bsItemTemplate" typeaheadOptionField="label"
                          [ngModelOptions]="{standalone: true}" (keydown.enter)="$event.preventDefault()" />
                      </div>
                    </div>
                  </div>
              </div>
            </div>

            <!-- <hr> -->

            <div class="row">
                <div class="col-md-12" style="background:#f7f7f7; padding:0; height:100%;">
                  
                  <tabset #staticTabs class="nav-full-width">
                    <tab heading="Data">                
                      <div id="hierarchy-tree-container" class="location-management-widget-section location-management-list-container"
                      style="height: calc(100vh - 290px);overflow-y: auto;">
                        <div class="list-group">

                          <!-- If -->
                          <div *ngIf="nodes.length < 1 && breadcrumbs.length === 0" [@fadeInOnEnter] style="padding: 20px;text-align: center;color: grey;">
                            <h4>No Sites in this area.</h4>
                            <p>
                              Zoom out to find sites in other areas of the map.
                            </p>
                          </div>

                          <!-- Else -->
                          <div *ngIf="nodes.length < 1 && breadcrumbs.length > 0" [@fadeInOnEnter] style="padding: 20px;text-align: center;color: grey;">
                            <h4>No data at this level.</h4>
                            <p>
                              Create data containers as part of the upload process.
                            </p>
                          </div>

                          <div *ngFor="let node of nodes; let i = index" [@fadeInOnEnter] class="list-group-item">

                            <!-- Two column layout -->
                            <div [@fadeInOnEnter] style="border-left: solid 15px;" class="card card-default clickable" *ngIf="getMetadata(node).root" [ngClass]="{'active': hoverFeatureId === node.id}"
                                (click)="select(node, null, $event)" (mouseenter)="onListEntityHover($event, node)" (mouseleave)="onListEntityHoverOff()">
                              
                                <!-- <div class="card-header">Header</div> -->
                              <div class="card-body card-5-7" >
                                <div class="card-left">
                                  <!-- <img src="https://via.placeholder.com/75x75" class="img-responsive"> -->
                                   <i class="fas fa-map-marker-alt" style="font-size: 50px;"></i>
                                </div>
                                <div class="card-right">
                                  <h4 style="word-break: break-all;">
                                    <!-- <a (click)="select(node, $event)"> -->
                                      {{node.name}}
                                    <!-- </a> -->
                                  </h4>
                                  <span *ngIf="node.type !== 'folder'" class="pull-right button-column floating" style="top: 0;position: absolute;right: 0;">
                                    <a class="fa fa-pencil-alt ico-edit" (click)="handleEdit(node, $event)" title="Edit"></a>
                                    <a class="fa fa-trash-alt ico-remove" (click)="handleDelete(node, $event)" title="Delete"></a>                                   
                                  </span>  
                                  <p><b>{{node.numberOfChildren}}</b> {{getMetadata(node).childLabel}}</p>
                                </div>
                              </div>
                              <!-- <div class="card-footer">Footer</div> -->
                            </div>


                            <!-- Single column card -->
                            <div [@fadeInOnEnter] class="card card-default clickable" *ngIf="!getMetadata(node).root" (click)="select(node, null, $event)">
                              <div class="card-body">
                                  <i (click)="handleExpand(node, $event)" class="fa fa-caret-left expand-arrow-ico pull-right" [ngClass]="{'fa-rotate-270':node.active}" style="font-size: 25px; padding: 0 5px" aria-hidden="true"></i>

                                  <h4 style="word-break: break-all;">{{node.name}}</h4>
                                  <p><b>{{node.numberOfChildren}}</b> {{getMetadata(node).childLabel}}</p>
                                  
                                  <div [collapse]="!node.active" class="list-group" style="margin-bottom: 0;">
                                    <div *ngFor="let child of node.children" (click)="select(child, node, $event)" class="list-group-item" style="background-color: #ececec;border: solid 1px lightgrey;border-radius: 0;">
                                      <!-- <a (click)="select(child, $event)"> -->
                                        {{child.name}}
                                      <!-- </a> -->
                                      <span *ngIf="child.type !== 'folder'" class="pull-right button-column">
                                        <a class="fa fa-pencil-alt ico-edit" (click)="handleEdit(child, $event)" title="Edit"></a>
                                        <a class="fa fa-trash-alt ico-remove" (click)="handleDelete(child, $event)" title="Delete"></a>                                   
                                      </span>                                 
                                    </div>
                                  </div>
                              </div>
                            </div>

                          </div> 

                          <div *ngFor="let node of supportingData" class="list-group-item">
                            <div [@fadeInOnEnter] class="card card-default">
                              <div class="card-body">
                                <h4 style="word-break: break-all;">Supporting Data</h4>
                                <div class="list-group">
                                  <div class="list-group-item" style="background-color: #ececec;border: solid 1px lightgrey;border-radius: 0;">
                                    <a (click)="select(node, null, $event)">
                                      {{node.name}}
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                      <!-- <div *ngIf="supportingData.length > 0" class="location-management-widget-section location-management-list-container">
                        
                            <div class="card card-default">
                              <div class="card-body">
                                <h4>Supporting Data</h4>
                                <div class="list-group">
                                  <div *ngFor="let node of supportingData" class="list-group-item" style="background-color: #ececec;border: solid 1px lightgrey;border-radius: 0;">
                                    <a (click)="select(node, $event)">
                                      {{node.name}}
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                      </div> -->

                    </tab>
                    <tab *ngIf="current != null" heading="Products">
                      <div id="hierarchy-tree-container" class="location-management-widget-section location-management-list-container"
                      style="height: calc(100vh - 290px);overflow-y: auto;">
                        <product-panel [id]="current.id" (toggleMapOrtho)="handleMapOrtho($event)" (toggleMapDem)="handleMapDem($event)"></product-panel>           
                      </div>
                    </tab>
                  </tabset>

                </div>
            </div>
            

            <footer class="sidebar-footer">
              <div class="row" *ngIf="current != null" style="background:white;">
                <div class="col-md-12" style="text-align: center;padding: 10px;border-top: 1px solid lightgrey;">
                  <button (click)="handleUploadFile()" class="btn btn-primary">Upload</button>              
                </div>
              </div>
              <div class="row" *ngIf="current == null" style="background:white;">
                <div class="col-md-12" style="text-align: center;padding: 10px;border-top: 1px solid lightgrey;">
                  <button (click)="handleCreate(null,null)" class="btn btn-primary">Add new site</button>
                </div>
              </div>
            </footer>
            
        </div>
        <div class="col-md-9" id="site-explorer-map">
            <div class="row">
                <article style="position: absolute;z-index: 5;margin-left: 100px;margin-top: 10px;">
                  <div class="idm-toast" *ngFor="let task of tasks; let idx = index">
                    <alert *ngIf="task.status === 'Complete' && task.actions.length === 0" type="success" [dismissible]="true" (onClosed)="handleCloseToast(idx)">
                      <strong>Upload {{task.status}}</strong> for {{task.collectionLabel}}. <a (click)="handleViewSite(task.collection)">Goto the collection view</a>
                    </alert>
                    <alert *ngIf="task.status === 'Complete' && task.actions.length !== 0" type="warning" [dismissible]="true" (onClosed)="handleCloseToast(idx)">
                      <strong>Upload {{task.status}}</strong> for {{task.collectionLabel}}. Task completed with warnings.  See the <a routerLink="/site/tasks">task page</a> for more details.
                    </alert>
                    <alert *ngIf="task.status === 'Failed'" type="danger" [dismissible]="true" (onClosed)="handleCloseToast(idx)">
                      <strong>Upload {{task.status}}</strong> for {{task.collectionLabel}}. Task completed with errors.  See the <a routerLink="/site/tasks">task page</a> for more details.
                    </alert>
                    <alert *ngIf="task.status !== 'Failed' && task.status !== 'Complete'" type="info" [dismissible]="true" (onClosed)="handleCloseToast(idx)">
                      <strong>Upload {{task.status}}</strong> for {{task.collectionLabel}}.
                    </alert>
                  </div>    
                </article>


                <article class="base-layer-panel">

                  <div class="layer-toggle" style="cursor: pointer;background:#fff;padding:8px;border-radius:4px;" (mouseenter)="baselayerIconHover = true"  (mouseleave)="baselayerIconHover = false">
                    <i class="fas fa-layer-group" *ngIf="!baselayerIconHover" style="vertical-align:middle; font-size: 18px;"></i>
                    <div *ngIf="baselayerIconHover">
                      <div class="row-form" *ngFor="let baseLayer of baseLayers">
                          <input class="layer-toggle-input" type='radio' name='rtoggle' [value]='baseLayer.id' [checked]="baseLayer.selected" (change)="handleStyle(baseLayer)">
                          <label class="layer-toggle-label">{{baseLayer.label}}</label>
                        </div>
                    </div>
                  </div>
                    <!-- <accordion> 
                      <accordion-group heading="Base Maps" style="border:none;">
                        <div class="row-form" *ngFor="let baseLayer of baseLayers">
                          <input class="layer-toggle-input" type='radio' name='rtoggle' [value]='baseLayer.id' [checked]="baseLayer.selected" (change)="handleStyle(baseLayer)">
                          <label class="layer-toggle-label">{{baseLayer.label}}</label>
                        </div>
                      </accordion-group>
                    </accordion> -->
                </article>

                <div id="mousemove-panel" class="mapboxgl-ctrl-bottom-right" style="background: rgba(255, 255, 255, .5); right: 0; padding: 0 5px 0 5px;bottom: 15px;"></div>

                <div id="map" class="map-view-port"></div>
            </div>
        </div>
    </div>
</div>

<ng-template #bsItemTemplate let-match="match" let-query="query">
  <span *ngIf="match.item.filename == null">
    <i class="fa fa-folder-open"></i>
  </span>
  <span *ngIf="match.item.filename != null">
    <i class="fa fa-file"></i>
  </span>
  <span>
    <span *ngFor="let site of match.item.hierarchy; index as i">
        {{site.label}} /
        <!-- <span *ngIf="i < (match.item.hierarchy.length -1)">/</span> -->
    </span>
  </span>
  <b>{{ match.item.label}}</b>
</ng-template>

